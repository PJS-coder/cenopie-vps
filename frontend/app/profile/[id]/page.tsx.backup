'use client';

import { useState, useEffect, useRef, useCallback } from 'react';
import { useRouter, useParams } from 'next/navigation';
import { 
  UserIcon, 
  PencilIcon, 
  BriefcaseIcon, 
  AcademicCapIcon, 
  MapPinIcon, 
  CalendarIcon, 
  CheckCircleIcon, 
  TrophyIcon, 
  EyeIcon, 
  CameraIcon,
  PlusIcon,
  XMarkIcon,
  EllipsisVerticalIcon,
  EnvelopeIcon,
  UserPlusIcon,
  ClockIcon,
  ChatBubbleLeftIcon,
  ArrowLeftIcon,
  ArrowPathIcon,
  AtSymbolIcon,
  BuildingOfficeIcon,
  ChevronDownIcon,
  LinkIcon,
  PhoneIcon,
  TrashIcon,
} from '@heroicons/react/24/outline';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { profileApi, companyApi } from '@/lib/api'; 
import ProtectedRoute from '@/components/ProtectedRoute';
import ConnectButton from '@/components/ConnectButton';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import Image from 'next/image';
import VerificationBadge from '@/components/VerificationBadge';
import PostCard from '@/components/PostCard';
import { useUserPosts } from '@/hooks/useUserPosts';

// --- Interface Definitions ---

interface Company {
  _id: string;
  name: string;
  description?: string;
  industry?: string;
  website?: string;
  logo?: string;
  location?: string;
  size?: string;
  founded?: number;
  isVerified?: boolean;
  createdAt: string;
}

interface UserProfile {
  id: string;
  name: string;
  email: string;
  headline?: string | null;
  bio?: string | null;
  location?: string | null;
  pronouns?: string | null;
  links?: { label: string; url: string }[];
  followers: string[];
  following: string[];
  education?: {
    _id?: string;
    college: string;
    degree: string;
    fieldOfStudy: string;
    startYear: number;
    endYear: number;
    current: boolean;
  }[];
  experience?: {
    _id?: string;
    company: string;
    jobTitle: string;
    employmentType: string;
    startDate: string; 
    endDate?: string | null;
    description?: string | null;
    current: boolean;
  }[];
  skills?: {
    _id?: string;
    name: string;
  }[];
  companies?: Company[];
  profileImage?: string | null;
  bannerImage?: string | null;
  interviewsCompleted?: number;
  applicationsSent?: number;
  profileViews?: number;
  successRate?: number;
  isVerified?: boolean;
  createdAt: string;
  connectionStatus?: 'none' | 'pending_sent' | 'pending_received' | 'accepted' | 'self';
  connectionId?: string | null;
}

interface EducationForm {
  college: string;
  degree: string;
  fieldOfStudy: string;
  startYear: number;
  endYear: number;
  current: boolean;
  [key: string]: any;
}

interface ExperienceForm {
  company: string;
  jobTitle: string;
  employmentType: string;
  startDate: string;
  endDate: string;
  description: string;
  current: boolean;
  [key: string]: any;
}

interface SkillForm {
  name: string;
}

// Helper to format ISO string to YYYY-MM-DD for <input type="date">
const formatDateForInput = (dateString: string | null | undefined): string => {
  if (!dateString) return '';
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return '';
    return date.toISOString().split('T')[0];
  } catch (e) {
    return '';
  }
};

// --- User Posts Section Component ---

const UserPostsSection = ({ userId, isOwnProfile, currentUserId }: { userId: string; isOwnProfile: boolean; currentUserId: string | null }) => {
  const { posts, loading, error } = useUserPosts(userId);
  const router = useRouter();

  if (loading) {
    return (
      <div className="flex justify-center items-center h-32">
        <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="bg-red-50 border border-red-200 rounded-lg p-4">
        <div className="text-red-800 font-medium">Error loading posts</div>
        <div className="text-red-600 text-sm mt-1">{error}</div>
      </div>
    );
  }

  if (posts.length === 0) {
    return (
      <p className="text-gray-500 italic">
        {isOwnProfile ? 'You haven\'t posted anything yet.' : 'This user hasn\'t posted anything yet.'}
      </p>
    );
  }

  // Show only the first 2 posts in a horizontal layout
  const displayedPosts = posts.slice(0, 2);

  return (
    <div className="space-y-4">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {displayedPosts.map((post: any) => (
          <div key={post.id} className="w-full">
            <PostCard
              id={post.id}
              author={post.author}
              role={post.role}
              content={post.content}
              likes={post.likes}
              comments={post.comments}
              shares={post.shares}
              timestamp={post.timestamp}
              image={post.image}
              mediaType={post.mediaType}
              isUserConnected={post.isConnected}
              currentUserId={currentUserId || undefined}
              postAuthorId={post.authorId}
              profileImage={post.profileImage}
              isRepost={post.isRepost}
              originalPost={post.originalPost}
            />
          </div>
        ))}
      </div>
      {posts.length > 2 && (
        <div className="text-center mt-4">
          <Button 
            variant="outline" 
            className="border-[#0CC0DF] text-[#0CC0DF] hover:bg-[#0CC0DF] hover:text-white"
            onClick={() => router.push(`/profile/${userId}/posts`)}
          >
            View More Posts
          </Button>
        </div>
      )}
    </div>
  );
};

// --- Profile Page Component ---

function ProfilePage() {
  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [companies, setCompanies] = useState<Company[]>([]);
  const [isEditing, setIsEditing] = useState(false);
  const [activeForm, setActiveForm] = useState<string | null>(null); 
  const [profileImagePreview, setProfileImagePreview] = useState<string | null>(null);
  const [bannerImagePreview, setBannerImagePreview] = useState<string | null>(null);
  const [profileImageFile, setProfileImageFile] = useState<File | null>(null);
  const [bannerImageFile, setBannerImageFile] = useState<File | null>(null);
  
  const [basicInfoForm, setBasicInfoForm] = useState<Partial<UserProfile>>({});
  const [educationForm, setEducationForm] = useState<EducationForm>({
    college: '',
    degree: '',
    fieldOfStudy: '',
    startYear: new Date().getFullYear(),
    endYear: new Date().getFullYear(),
    current: false
  });
  const [experienceForm, setExperienceForm] = useState<ExperienceForm>({
    company: '',
    jobTitle: '',
    employmentType: '',
    startDate: '',
    endDate: '',
    description: '',
    current: false
  });
  const [skillForm, setSkillForm] = useState<SkillForm>({
    name: ''
  });
  
  const profileImageRef = useRef<HTMLInputElement>(null);
  const bannerImageRef = useRef<HTMLInputElement>(null);
  const router = useRouter();
  const params = useParams();
  const userId = params.id as string;

  const getCurrentUserId = () => {
    try {
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
      return currentUser._id || currentUser.id;
    } catch (error) {
      return null;
    }
  };
  
  const currentUserId = getCurrentUserId();
  const isOwnProfile = currentUserId && currentUserId === userId;
  
  
  // --- Profile Fetching ---
  
  const fetchUserCompanies = useCallback(async (userId: string) => {
    // Set empty array by default since we don't have companies functionality yet
    setCompanies([]);
    /*
    // Commented out until companies API is implemented
    try {
      // This is a placeholder for when the companies API is available
      // const response = await companyApi.getMyCompanies();
      // if (response.data) {
      //   setCompanies(Array.isArray(response.data) ? response.data : []);
      // }
    } catch (err) {
      console.error('Error fetching user companies:', err);
      setCompanies([]);
    }
    */
  }, []);

  const refetchProfile = useCallback(async (idToFetch: string | null) => {
    try {
      setError(null);
      setLoading(true);
      
      const response = idToFetch 
        ? await profileApi.getProfileById(idToFetch)
        : await profileApi.getProfile();
        
      const userProfile = response.data?.user || response.user;
      
      if (userProfile) {
        const id = (userProfile as { id?: string; _id?: string }).id || (userProfile as { id?: string; _id?: string })._id || '';
        
        const mappedProfile: UserProfile = {
          ...userProfile as UserProfile, 
          id,
        };
        setProfile(mappedProfile);
        
        // Fetch companies for this user
        if (id) {
          await fetchUserCompanies(id);
        }
        
        setBasicInfoForm({
          name: mappedProfile.name || '',
          headline: mappedProfile.headline || '',
          bio: mappedProfile.bio || '',
          location: mappedProfile.location || '',
          pronouns: mappedProfile.pronouns || ''
        });
        
        // Connection status is now handled by ConnectButton component
        
      } else {
        setError('User profile not found');
      }
    } catch (err) {
      console.error('Profile fetch error:', err);
      setError(err instanceof Error ? err.message : 'Failed to fetch profile');
    } finally {
      setLoading(false);
    }
  }, [currentUserId]);

  useEffect(() => {
    const idToFetch = userId || null; 
    refetchProfile(idToFetch);
  }, [userId, refetchProfile]);

  // --- Form Handlers and CRUD Logic ---
  
  const resetEducationForm = () => setEducationForm({
    college: '',
    degree: '',
    fieldOfStudy: '',
    startYear: new Date().getFullYear(),
    endYear: new Date().getFullYear(),
    current: false
  });
  
  const resetExperienceForm = () => setExperienceForm({
    company: '',
    jobTitle: '',
    employmentType: '',
    startDate: '',
    endDate: '',
    description: '',
    current: false
  });

  const handleEdit = () => {
    setIsEditing(!isEditing);
    if (!isEditing && profile) {
      setBasicInfoForm({
        name: profile.name || '',
        headline: profile.headline || '',
        bio: profile.bio || '',
        location: profile.location || '',
        pronouns: profile.pronouns || ''
      });
    } else {
        setProfileImagePreview(null);
        setBannerImagePreview(null);
        setProfileImageFile(null);
        setBannerImageFile(null);
        setActiveForm(null); 
    }
  };

  const handleSaveProfile = async () => {
    try {
      setLoading(true);
      const formData = new FormData();
      
      // Add basic info fields
      Object.keys(basicInfoForm).forEach(key => {
        const value = basicInfoForm[key as keyof typeof basicInfoForm];
        if (value !== undefined && value !== null) { 
          formData.append(key, value as string);
        }
      });
      
      // Add stats fields if they exist
      if (profile?.interviewsCompleted !== undefined) {
        formData.append('interviewsCompleted', profile.interviewsCompleted.toString());
      }
      if (profile?.applicationsSent !== undefined) {
        formData.append('applicationsSent', profile.applicationsSent.toString());
      }
      if (profile?.profileViews !== undefined) {
        formData.append('profileViews', profile.profileViews.toString());
      }
      if (profile?.successRate !== undefined) {
        formData.append('successRate', profile.successRate.toString());
      }
      
      // Add profile and banner images if they exist
      if (profileImageFile) {
        formData.append('profileImage', profileImageFile);
      }
      
      if (bannerImageFile) {
        formData.append('bannerImage', bannerImageFile);
      }
      
      // If we have image files, use FormData; otherwise use JSON
      let response;
      if (profileImageFile || bannerImageFile) {
        // Use FormData for file uploads
        response = await profileApi.updateProfile(formData);
      } else {
        // Use JSON for text-only updates
        const profileUpdate = {
          name: basicInfoForm.name || undefined,
          headline: basicInfoForm.headline || undefined,
          bio: basicInfoForm.bio || undefined,
          location: basicInfoForm.location || undefined,
          pronouns: basicInfoForm.pronouns || undefined
        };
        response = await profileApi.updateProfile(profileUpdate);
      }
      
      // Handle the response based on its structure
      const updatedProfile = (response as any)?.data?.user || (response as any)?.user || response;
      if (updatedProfile) {
        const id = (updatedProfile as { id?: string; _id?: string }).id || (updatedProfile as { id?: string; _id?: string })._id || '';
        const profileWithId = {
          ...updatedProfile as UserProfile,
          id
        };
        setProfile(profileWithId);
        
        // Update localStorage if this is the current user's profile
        const currentUserId = getCurrentUserId();
        if (currentUserId && (id === currentUserId || (updatedProfile as any)._id === currentUserId)) {
          localStorage.setItem('currentUser', JSON.stringify(profileWithId));
          window.dispatchEvent(new Event('storage'));
          window.dispatchEvent(new Event('profileUpdated'));
        }
      }
      setIsEditing(false);
      setProfileImagePreview(null);
      setBannerImagePreview(null);
      setProfileImageFile(null);
      setBannerImageFile(null);
      setActiveForm(null); 
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to update profile');
      console.error('Profile update error:', err);
    } finally {
      setLoading(false);
    }
  };

  const addEducation = async () => {
    try {
      setLoading(true);
      const educationData = {
        ...educationForm,
        startYear: Number(educationForm.startYear), 
        endYear: Number(educationForm.endYear),
      };
      
      await profileApi.addEducation(educationData);
      await refetchProfile(currentUserId); 
      resetEducationForm();
      setActiveForm(null);
    } catch (err) {
      console.error('Add education error:', err);
      setError(err instanceof Error ? err.message : 'Failed to add education');
    } finally {
      setLoading(false);
    }
  };

  const addExperience = async () => {
    try {
      setLoading(true);
      await profileApi.addExperience(experienceForm);
      await refetchProfile(currentUserId); 
      resetExperienceForm();
      setActiveForm(null);
    } catch (err) {
      console.error('Add experience error:', err);
      setError(err instanceof Error ? err.message : 'Failed to add experience');
    } finally {
      setLoading(false);
    }
  };

  const updateEducation = async (id: string) => {
    try {
      setLoading(true);
      const educationData = {
        ...educationForm,
        startYear: Number(educationForm.startYear), 
        endYear: Number(educationForm.endYear),
      };
      
      await profileApi.updateEducation(id, educationData);
      await refetchProfile(currentUserId); 
      resetEducationForm();
      setActiveForm(null);
    } catch (err) {
      console.error('Update education error:', err);
      setError(err instanceof Error ? err.message : 'Failed to update education');
    } finally {
      setLoading(false);
    }
  };

  const updateExperience = async (id: string) => {
    try {
      setLoading(true);
      await profileApi.updateExperience(id, experienceForm);
      await refetchProfile(currentUserId);
      resetExperienceForm();
      setActiveForm(null);
    } catch (err) {
      console.error('Update experience error:', err);
      setError(err instanceof Error ? err.message : 'Failed to update experience');
    } finally {
      setLoading(false);
    }
  };

  const deleteEducation = async (id: string) => {
    try {
      setLoading(true);
      await profileApi.deleteEducation(id);
      await refetchProfile(currentUserId); 
      setActiveForm(null);
    } catch (err) {
      console.error('Delete education error:', err);
      setError(err instanceof Error ? err.message : 'Failed to delete education');
    } finally {
      setLoading(false);
    }
  };

  const deleteExperience = async (id: string) => {
    try {
      setLoading(true);
      await profileApi.deleteExperience(id);
      await refetchProfile(currentUserId); 
      setActiveForm(null);
    } catch (err) {
      console.error('Delete experience error:', err);
      setError(err instanceof Error ? err.message : 'Failed to delete experience');
    } finally {
      setLoading(false);
    }
  };

  const addSkill = async () => {
    if (profile && skillForm.name.trim()) {
      setLoading(true);
      try {
        const newSkill = { name: skillForm.name.trim() };
        const updatedProfile = {
          ...profile,
          skills: [...(profile.skills || []), newSkill]
        };
        
        // Save to backend
        // Clean up null values to ensure they're undefined for the API
        const cleanProfileData: Partial<UserProfile> = {};
        Object.keys(updatedProfile).forEach(key => {
          const value = (updatedProfile as any)[key];
          if (value !== null) {
            (cleanProfileData as any)[key] = value;
          }
        });
        
        const response = await profileApi.updateProfile(cleanProfileData as any);
        const savedProfile = (response.data as UserProfile) || (response as any);
        
        if (savedProfile) {
          const id = savedProfile.id || (savedProfile as any)._id || '';
          const profileWithId = {
            ...savedProfile as UserProfile,
            id
          };
          setProfile(profileWithId);

          // Update localStorage if this is the current user's profile
          const currentUserId = getCurrentUserId();
          if (currentUserId && (id === currentUserId || (savedProfile as any)._id === currentUserId)) {
            localStorage.setItem('currentUser', JSON.stringify(profileWithId));
            window.dispatchEvent(new Event('storage'));
            window.dispatchEvent(new Event('profileUpdated'));
          }
        }
        
        setSkillForm({ name: '' });
        setActiveForm(null);
      } catch (error) {
        console.error('Error adding skill:', error);
        alert('Failed to add skill');
      } finally {
        setLoading(false);
      }
    }
  };

  const deleteSkill = async (id: string) => {
    if (profile) {
      setLoading(true);
      try {
        const updatedProfile = {
          ...profile,
          skills: profile.skills?.filter(skill => skill._id !== id && skill.name !== id)
        };
        
        // Save to backend
        // Clean up null values to ensure they're undefined for the API
        const cleanProfileData: Partial<UserProfile> = {};
        Object.keys(updatedProfile).forEach(key => {
          const value = (updatedProfile as any)[key];
          if (value !== null) {
            (cleanProfileData as any)[key] = value;
          }
        });
        
        const response = await profileApi.updateProfile(cleanProfileData as any);
        const savedProfile = (response.data as UserProfile) || (response as any);
        
        if (savedProfile) {
          const profileId = savedProfile.id || (savedProfile as any)._id || '';
          const profileWithId = {
            ...savedProfile as UserProfile,
            id: profileId
          };
          setProfile(profileWithId);

          // Update localStorage if this is the current user's profile
          const currentUserId = getCurrentUserId();
          if (currentUserId && (profileId === currentUserId || (savedProfile as any)._id === currentUserId)) {
            localStorage.setItem('currentUser', JSON.stringify(profileWithId));
            window.dispatchEvent(new Event('storage'));
            window.dispatchEvent(new Event('profileUpdated'));
          }
        }
      } catch (error) {
        console.error('Error deleting skill:', error);
        alert('Failed to delete skill');
      } finally {
        setLoading(false);
      }
    }
  };

  const handleImageChange = (e: React.ChangeEvent<HTMLInputElement>, type: 'profile' | 'banner') => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        if (type === 'profile') {
          setProfileImagePreview(reader.result as string);
          setProfileImageFile(file);
        } else {
          setBannerImagePreview(reader.result as string);
          setBannerImageFile(file);
        }
      };
      reader.readAsDataURL(file);
    }
  };

  const triggerProfileImageUpload = () => {
    profileImageRef.current?.click();
  };

  const triggerBannerImageUpload = () => {
    bannerImageRef.current?.click();
  };
  
  // Connection logic is now handled by ConnectButton component

  const handleMessage = () => {
    if (!profile) return;
    const userName = profile.name && profile.name !== 'User' && profile.name !== 'Unknown User' 
      ? encodeURIComponent(profile.name) 
      : '';
    router.push(`/messages?user=${profile.id}${userName ? `&name=${userName}` : ''}`);
  };

  // Connection button logic is now handled by ConnectButton component

  // Real-time connection updates are now handled by ConnectButton component
  
  // Connection status monitoring is now handled by ConnectButton component
  
  // --- Render ---

  if (loading) {
    return (
      <ProtectedRoute>
        <div className="flex justify-center items-center h-screen">
          <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
        </div>
      </ProtectedRoute>
    );
  }

  if (error) {
    return (
      <ProtectedRoute>
        <div className="flex justify-center items-center h-screen">
          <div className="text-center">
            <h2 className="text-xl font-bold text-red-500">Error loading profile</h2>
            <p className="text-gray-600">{error}</p>
            <Button onClick={() => window.location.reload()} className="mt-4">
              Retry
            </Button>
          </div>
        </div>
      </ProtectedRoute>
    );
  }

  if (!profile) {
    return (
      <ProtectedRoute>
        <div className="flex justify-center items-center h-screen">
          <div className="text-center">
            <h2 className="text-xl font-bold">Profile not found</h2>
            <p className="text-gray-600">Redirecting to profile setup...</p>
          </div>
        </div>
      </ProtectedRoute>
    );
  }

  return (
    <ProtectedRoute>
      <div className="min-h-screen bg-gray-50">
        <div className="w-full flex justify-center px-4 lg:px-6">
          <div className="w-full lg:w-[1200px] py-8">
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              
              {/* Left Sidebar - Profile Card */}
              <div className="lg:col-span-1">
                <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden sticky top-6">
                  {/* Profile Header */}
                  <div className="relative">
                    {/* Banner */}
                    <div className="h-24 bg-gradient-to-r from-blue-500 to-purple-600"></div>
                    
                    {/* Profile Image */}
                    <div className="absolute -bottom-12 left-1/2 transform -translate-x-1/2">
                      {isEditing && isOwnProfile ? (
                        <div 
                          className="relative w-24 h-24 bg-white rounded-full flex items-center justify-center cursor-pointer border-4 border-white shadow-lg"
                          onClick={triggerProfileImageUpload}
                        >
                          {profileImagePreview ? (
                            <Image 
                              src={profileImagePreview} 
                              alt="Profile preview" 
                              width={96}
                              height={96}
                              className="w-full h-full object-cover rounded-full"
                            />
                          ) : profile.profileImage ? (
                            <Image 
                              src={profile.profileImage} 
                              alt="Profile" 
                              width={96}
                              height={96}
                              className="w-full h-full object-cover rounded-full"
                            />
                          ) : (
                            <UserIcon className="w-12 h-12 text-gray-400" />
                          )}
                          <div className="absolute bottom-0 right-0 bg-blue-500 rounded-full p-1">
                            <CameraIcon className="w-3 h-3 text-white" />
                          </div>
                          <input
                            type="file"
                            ref={profileImageRef}
                            className="hidden"
                            accept="image/*"
                            onChange={(e) => handleImageChange(e, 'profile')}
                          />
                        </div>
                      ) : (
                        <div className="relative w-24 h-24 bg-white rounded-full flex items-center justify-center border-4 border-white shadow-lg">
                          {profile.profileImage ? (
                            <Image 
                              src={profile.profileImage} 
                              alt={profile.name} 
                              width={96}
                              height={96}
                              className="w-full h-full object-cover rounded-full"
                            />
                          ) : (
                            <UserIcon className="w-12 h-12 text-gray-400" />
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                  
                  {/* Profile Info */}
                  <div className="pt-16 pb-6 px-6 text-center">
                    {isEditing && isOwnProfile ? (
                      <div className="space-y-3">
                        <Input
                          value={basicInfoForm.name || ''}
                          onChange={(e) => setBasicInfoForm({...basicInfoForm, name: e.target.value})}
                          className="text-center font-bold text-lg"
                          placeholder="Your Name"
                        />
                        <Input
                          value={basicInfoForm.headline || ''}
                          onChange={(e) => setBasicInfoForm({...basicInfoForm, headline: e.target.value})}
                          placeholder="Your Title"
                          className="text-center text-gray-600"
                        />
                      </div>
                    ) : (
                      <>
                        <div className="flex items-center justify-center gap-2 mb-2">
                          <h1 className="text-xl font-bold text-gray-900">{profile.name}</h1>
                          <VerificationBadge isVerified={profile.isVerified} size="sm" />
                        </div>
                        {profile.headline && (
                          <p className="text-gray-600 text-sm mb-3">{profile.headline}</p>
                        )}
                      </>
                    )}
                    
                    {/* Location */}
                    {isEditing && isOwnProfile ? (
                      <Input
                        value={basicInfoForm.location || ''}
                        onChange={(e) => setBasicInfoForm({...basicInfoForm, location: e.target.value})}
                        placeholder="Location"
                        className="text-center text-gray-500 text-sm"
                      />
                    ) : (
                      profile.location && (
                        <p className="text-gray-500 text-sm flex items-center justify-center gap-1 mb-4">
                          <MapPinIcon className="w-4 h-4" />
                          {profile.location}
                        </p>
                      )
                    )}
                    
                    {/* Bio */}
                    {isEditing && isOwnProfile ? (
                      <Textarea
                        value={basicInfoForm.bio || ''}
                        onChange={(e) => setBasicInfoForm({...basicInfoForm, bio: e.target.value})}
                        placeholder="Tell us about yourself..."
                        className="text-sm text-gray-700 min-h-[80px] mt-4"
                      />
                    ) : (
                      profile.bio && (
                        <p className="text-sm text-gray-700 leading-relaxed mt-4 text-left">
                          {profile.bio}
                        </p>
                      )
                    )}
                    
                    {/* Action Buttons */}
                    <div className="mt-6 space-y-2">
                      {isEditing && isOwnProfile ? (
                        <>
                          <Button
                            onClick={handleSaveProfile}
                            className="w-full bg-green-600 hover:bg-green-700 text-white"
                          >
                            Save Changes
                          </Button>
                          <Button
                            onClick={handleEdit}
                            variant="outline"
                            className="w-full"
                          >
                            Cancel
                          </Button>
                        </>
                      ) : (
                        <>
                          {!isOwnProfile && (
                            <>
                              <Button
                                onClick={handleMessage}
                                variant="outline"
                                className="w-full gap-2"
                              >
                                <ChatBubbleLeftIcon className="w-4 h-4" />
                                Message
                              </Button>
                              {currentUserId && profile && (
                                <ConnectButton
                                  userId={profile.id}
                                  userName={profile.name}
                                  currentUserId={currentUserId}
                                  initialStatus={(profile as any).connectionStatus || 'none'}
                                  initialConnectionId={(profile as any).connectionId || null}
                                  size="md"
                                />
                              )}
                            </>
                          )}
                          {isOwnProfile && (
                            <Button
                              onClick={handleEdit}
                              className="w-full bg-blue-600 hover:bg-blue-700 text-white"
                            >
                              <PencilIcon className="w-4 h-4 mr-2" />
                              Edit Profile
                            </Button>
                          )}
                        </>
                      )}
                    </div>
                    
                    {/* Skills Section */}
                    <div className="mt-6 text-left">
                      <div className="flex items-center justify-between mb-3">
                        <h3 className="font-semibold text-gray-900 text-sm uppercase tracking-wide">Skills</h3>
                        {isEditing && isOwnProfile && (
                          <Button
                            size="sm"
                            onClick={() => setActiveForm(activeForm === 'skills' ? null : 'skills')}
                            variant="ghost"
                            className="p-1"
                          >
                            <PlusIcon className="w-4 h-4" />
                          </Button>
                        )}
                      </div>
                      
                      {activeForm === 'skills' && isEditing && isOwnProfile && (
                        <div className="mb-4 p-3 bg-gray-50 rounded-lg">
                          <Input
                            placeholder="Skill name"
                            value={skillForm.name}
                            onChange={(e) => setSkillForm({...skillForm, name: e.target.value})}
                            className="mb-2"
                          />
                          <div className="flex gap-2">
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={() => setActiveForm(null)}
                            >
                              Cancel
                            </Button>
                            <Button
                              size="sm"
                              onClick={addSkill}
                              disabled={!skillForm.name}
                            >
                              Add
                            </Button>
                          </div>
                        </div>
                      )}
                      
                      {profile.skills && profile.skills.length > 0 ? (
                        <div className="flex flex-wrap gap-2">
                          {profile.skills.map((skill) => (
                            <div key={skill._id || skill.name} className="flex items-center">
                              <Badge 
                                variant="secondary" 
                                className="bg-blue-100 text-blue-800 border-blue-200 text-xs"
                              >
                                {skill.name}
                                {isEditing && isOwnProfile && (
                                  <button
                                    onClick={() => deleteSkill(skill._id || skill.name)}
                                    className="ml-1 text-red-500 hover:text-red-700"
                                  >
                                    <XMarkIcon className="w-3 h-3" />
                                  </button>
                                )}
                              </Badge>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <p className="text-gray-500 text-xs italic">No skills added yet.</p>
                      )}
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Right Content Area */}
              <div className="lg:col-span-2 space-y-6">
                {/* Profile Stats */}
                <div className="grid grid-cols-2 gap-4 mb-6">
                  <div className="bg-white rounded-xl p-4 border border-gray-100 shadow-sm">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                        <CheckCircleIcon className="w-5 h-5 text-blue-600" />
                      </div>
                      <div>
                        <div className="text-lg font-bold text-gray-900">
                          {profile.interviewsCompleted || 0}
                        </div>
                        <div className="text-xs text-gray-600 uppercase tracking-wide">Interviews</div>
                      </div>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl p-4 border border-gray-100 shadow-sm">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                        <BriefcaseIcon className="w-5 h-5 text-green-600" />
                      </div>
                      <div>
                        <div className="text-lg font-bold text-gray-900">
                          {profile.applicationsSent || 0}
                        </div>
                        <div className="text-xs text-gray-600 uppercase tracking-wide">Applications</div>
                      </div>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl p-4 border border-gray-100 shadow-sm">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                        <EyeIcon className="w-5 h-5 text-purple-600" />
                      </div>
                      <div>
                        <div className="text-lg font-bold text-gray-900">
                          {profile.profileViews || 0}
                        </div>
                        <div className="text-xs text-gray-600 uppercase tracking-wide">Views</div>
                      </div>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl p-4 border border-gray-100 shadow-sm">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                        <TrophyIcon className="w-5 h-5 text-orange-600" />
                      </div>
                      <div>
                        <div className="text-lg font-bold text-gray-900">
                          {profile.successRate !== undefined ? `${profile.successRate}%` : '0%'}
                        </div>
                        <div className="text-xs text-gray-600 uppercase tracking-wide">Success</div>
                      </div>
                    </div>
                  </div>
                </div>
              
              {activeForm === 'skills' && isEditing && isOwnProfile && (
                <Card className="mb-4">
                  <CardContent className="p-4">
                    <div className="space-y-4">
                      <Input
                        placeholder="Skill name"
                        value={skillForm.name}
                        onChange={(e) => setSkillForm({...skillForm, name: e.target.value})}
                      />
                    </div>
                    <div className="flex justify-end gap-2 mt-3">
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => setActiveForm(null)}
                      >
                        Cancel
                      </Button>
                      <Button
                        size="sm"
                        onClick={addSkill}
                        disabled={!skillForm.name}
                      >
                        Add
                      </Button>
                    </div>
                  </CardContent>
                </Card>
              )}
              
              {profile.skills && profile.skills.length > 0 ? (
                <div className="flex flex-wrap gap-2">
                  {profile.skills.map((skill) => (
                    <div key={skill._id || skill.name} className="flex items-center"> 
                      <Badge variant="secondary" className="bg-[#0BC0DF]/10 text-[#0BC0DF] border-[#0BC0DF]/20">
                        {skill.name}
                        {isEditing && isOwnProfile && (
                          <button
                            onClick={() => deleteSkill(skill._id || skill.name)}
                            className="ml-2 text-red-500 hover:text-red-700"
                          >
                            <XMarkIcon className="w-3 h-3" />
                          </button>
                        )}
                      </Badge>
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-gray-500 dark:text-gray-400 italic">
                  No skills added yet.
                </p>
              )}
            </div>
          </div>
        </div>

        {/* Profile Stats */}
        <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
          <Card>
            <CardContent className="p-4 text-center">
              <div className="w-12 h-12 bg-blue-100 dark:bg-blue-900/20 rounded-full flex items-center justify-center mx-auto mb-2">
                <CheckCircleIcon className="w-6 h-6 text-blue-600 dark:text-blue-400" />
              </div>
              <div className="text-2xl font-bold text-gray-900 dark:text-white">
                {profile.interviewsCompleted || 0}
              </div>
              <div className="text-sm text-gray-600 dark:text-gray-400">Interviews Completed</div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-4 text-center">
              <div className="w-12 h-12 bg-green-100 dark:bg-green-900/20 rounded-full flex items-center justify-center mx-auto mb-2">
                <BriefcaseIcon className="w-6 h-6 text-green-600 dark:text-green-400" />
              </div>
              <div className="text-2xl font-bold text-gray-900 dark:text-white">
                {profile.applicationsSent || 0}
              </div>
              <div className="text-sm text-gray-600 dark:text-gray-400">Applications Sent</div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-4 text-center">
              <div className="w-12 h-12 bg-purple-100 dark:bg-purple-900/20 rounded-full flex items-center justify-center mx-auto mb-2">
                <EyeIcon className="w-6 h-6 text-purple-600 dark:text-purple-400" />
              </div>
              <div className="text-2xl font-bold text-gray-900 dark:text-white">
                {profile.profileViews || 0}
              </div>
              <div className="text-sm text-gray-600 dark:text-gray-400">Profile Views</div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-4 text-center">
              <div className="w-12 h-12 bg-orange-100 dark:bg-orange-900/20 rounded-full flex items-center justify-center mx-auto mb-2">
                <TrophyIcon className="w-6 h-6 text-orange-600 dark:text-orange-400" />
              </div>
              <div className="text-2xl font-bold text-gray-900 dark:text-white">
                {profile.successRate !== undefined ? `${profile.successRate}%` : '0%'}
              </div>
              <div className="text-sm text-gray-600 dark:text-gray-400">Success Rate</div>
            </CardContent>
          </Card>
        </div>

                {/* Work Experience Section */}
                <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                  <div className="bg-gradient-to-r from-blue-500 to-cyan-500 p-4">
                    <div className="flex items-center justify-between">
                      <h2 className="text-lg font-bold text-white flex items-center gap-2">
                        <BriefcaseIcon className="w-5 h-5" />
                        Work Experience
                      </h2>
                      {isOwnProfile && (
                        <Button
                          size="sm"
                          onClick={() => {
                            resetExperienceForm(); 
                            setActiveForm('experience-add'); 
                          }}
                          className="bg-white/20 hover:bg-white/30 text-white border-white/30"
                        >
                          <PlusIcon className="w-4 h-4 mr-1" />
                          Add
                        </Button>
                      )}
                    </div>
                  </div>
                  <div className="p-6">
              {/* Check for add form or an edit form */}
              {(activeForm === 'experience-add' || activeForm?.startsWith('experience-edit-')) && isOwnProfile && (
                <Card className="mb-4">
                  <CardContent className="p-4">
                    <div className="space-y-3">
                      <Input
                        placeholder="Job Title"
                        value={experienceForm.jobTitle}
                        onChange={(e) => setExperienceForm({...experienceForm, jobTitle: e.target.value})}
                      />
                      <Input
                        placeholder="Company"
                        value={experienceForm.company}
                        onChange={(e) => setExperienceForm({...experienceForm, company: e.target.value})}
                      />
                      <Input
                        placeholder="Employment Type (e.g., Full-time, Freelance)"
                        value={experienceForm.employmentType}
                        onChange={(e) => setExperienceForm({...experienceForm, employmentType: e.target.value})}
                      />
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <Input
                          type="date"
                          placeholder="Start Date"
                          value={experienceForm.startDate}
                          onChange={(e) => setExperienceForm({...experienceForm, startDate: e.target.value})}
                        />
                        <Input
                          type="date"
                          placeholder="End Date"
                          value={experienceForm.endDate || ''}
                          onChange={(e) => setExperienceForm({...experienceForm, endDate: e.target.value})}
                          disabled={experienceForm.current}
                        />
                      </div>
                      <div className="flex items-center">
                        <input
                          type="checkbox"
                          id="currentJob"
                          checked={experienceForm.current}
                          onChange={(e) => setExperienceForm({...experienceForm, current: e.target.checked})}
                          className="mr-2"
                        />
                        <label htmlFor="currentJob" className="text-sm">I currently work here</label>
                      </div>
                      <Textarea
                        placeholder="Description (Optional)"
                        value={experienceForm.description || ''}
                        onChange={(e) => setExperienceForm({...experienceForm, description: e.target.value})}
                        className="min-h-[80px]"
                      />
                    </div>
                    <div className="flex justify-end gap-2 mt-3">
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => setActiveForm(null)}
                      >
                        Cancel
                      </Button>
                      <Button
                        size="sm"
                        onClick={() => {
                          if (activeForm?.startsWith('experience-edit-')) {
                            const experienceId = activeForm.split('experience-edit-')[1];
                            updateExperience(experienceId);
                          } else {
                            addExperience();
                          }
                        }}
                        disabled={!experienceForm.company || !experienceForm.jobTitle || !experienceForm.startDate}
                      >
                        {activeForm?.startsWith('experience-edit-') ? 'Update' : 'Add'}
                      </Button>
                    </div>
                  </CardContent>
                </Card>
              )}
                
              <div className="space-y-6">
                {profile.experience && profile.experience.length > 0 ? (
                  <>
                    {profile.experience
                      .filter(exp => activeForm !== `experience-edit-${exp._id}`)
                      .map((exp) => (
                      <div key={exp._id} className="border-l-4 border-blue-500 pl-4 relative bg-gray-50 p-4 rounded-lg">
                        {isOwnProfile && exp._id && (
                          <div className="absolute -top-2 -right-2 z-10">
                            <DropdownMenu>
                              <DropdownMenuTrigger asChild>
                                <Button size="sm" variant="ghost" className="p-1 h-auto">
                                  <EllipsisVerticalIcon className="w-4 h-4" />
                                </Button>
                              </DropdownMenuTrigger>
                              <DropdownMenuContent align="end">
                                <DropdownMenuItem
                                  onSelect={() => {
                                    setExperienceForm({
                                      company: exp.company || '',
                                      jobTitle: exp.jobTitle || '',
                                      employmentType: exp.employmentType || '',
                                      startDate: exp.startDate ? new Date(exp.startDate).toISOString().split('T')[0] : '',
                                      endDate: exp.endDate ? new Date(exp.endDate).toISOString().split('T')[0] : '',
                                      description: exp.description || '',
                                      current: exp.current || false
                                    });
                                    setActiveForm(`experience-edit-${exp._id}`);
                                  }}
                                >
                                  Edit
                                </DropdownMenuItem>
                                <DropdownMenuItem
                                  className="text-red-600"
                                  onSelect={() => deleteExperience(exp._id!)}
                                >
                                  Delete
                                </DropdownMenuItem>
                              </DropdownMenuContent>
                            </DropdownMenu>
                          </div>
                        )}
                        <div className="flex flex-col sm:flex-row sm:items-start justify-between gap-2 mb-2 pr-8">
                          <div className="flex-1">
                            <h3 className="font-semibold text-lg text-gray-900">
                              {exp.jobTitle}
                            </h3>
                          </div>
                          {exp.current && (
                            <Badge className="bg-green-100 text-green-800 flex-shrink-0">
                              Current
                            </Badge>
                          )}
                        </div>
                        <p className="text-gray-700 font-medium">
                          {exp.company}
                        </p>
                        <p className="text-gray-600 text-sm mt-1">
                          {exp.startDate ? new Date(exp.startDate).toLocaleDateString() : 'Unknown Date'} - {
                            exp.current ? 'Present' : (exp.endDate ? new Date(exp.endDate).toLocaleDateString() : 'Unknown Date')
                          }
                        </p>
                        {exp.description && (
                          <p className="text-gray-700 mt-2">
                            {exp.description}
                          </p>
                        )}
                      </div>
                      ))}
                  </>
                ) : (
                  <div className="py-4">
                    <p className="text-gray-500 italic">
                      No work experience added yet.
                    </p>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Education Section */}
          <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div className="bg-gradient-to-r from-purple-500 to-pink-500 p-4">
              <div className="flex items-center justify-between">
                <h2 className="text-lg font-bold text-white flex items-center gap-2">
                  <AcademicCapIcon className="w-5 h-5" />
                  Education
                </h2>
                {isOwnProfile && (
                  <Button
                    size="sm"
                    onClick={() => {
                      resetEducationForm(); 
                      setActiveForm('education-add'); 
                    }}
                    className="bg-white/20 hover:bg-white/30 text-white border-white/30"
                  >
                    <PlusIcon className="w-4 h-4 mr-1" />
                    Add
                  </Button>
                )}
              </div>
            </div>
            <div className="p-6">
              {/* Check for add form or an edit form */}
              {(activeForm === 'education-add' || activeForm?.startsWith('education-edit-')) && isOwnProfile && (
                <Card className="mb-4">
                  <CardContent className="p-4">
                    <div className="space-y-3">
                      <Input
                        placeholder="College/University"
                        value={educationForm.college}
                        onChange={(e) => setEducationForm({...educationForm, college: e.target.value})}
                      />
                      <Input
                        placeholder="Degree"
                        value={educationForm.degree}
                        onChange={(e) => setEducationForm({...educationForm, degree: e.target.value})}
                      />
                      <Input
                        placeholder="Field of Study"
                        value={educationForm.fieldOfStudy}
                        onChange={(e) => setEducationForm({...educationForm, fieldOfStudy: e.target.value})}
                      />
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <Input
                          type="number"
                          placeholder="Start Year"
                          value={educationForm.startYear || ''} 
                          onChange={(e) => setEducationForm({...educationForm, startYear: parseInt(e.target.value) || 0})}
                        />
                        <Input
                          type="number"
                          placeholder="End Year"
                          value={educationForm.endYear || ''} 
                          onChange={(e) => setEducationForm({...educationForm, endYear: parseInt(e.target.value) || 0})}
                          disabled={educationForm.current}
                        />
                      </div>
                      <div className="flex items-center">
                        <input
                          type="checkbox"
                          id="currentStudy"
                          checked={educationForm.current}
                          onChange={(e) => setEducationForm({...educationForm, current: e.target.checked})}
                          className="mr-2"
                        />
                        <label htmlFor="currentStudy" className="text-sm">I currently study here</label>
                      </div>
                    </div>
                    <div className="flex justify-end gap-2 mt-3">
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => setActiveForm(null)}
                      >
                        Cancel
                      </Button>
                      <Button
                        size="sm"
                        onClick={() => {
                          if (activeForm?.startsWith('education-edit-')) {
                            const educationId = activeForm.split('education-edit-')[1];
                            updateEducation(educationId);
                          } else {
                            addEducation();
                          }
                        }}
                        disabled={!educationForm.college || !educationForm.degree}
                      >
                        {activeForm?.startsWith('education-edit-') ? 'Update' : 'Add'}
                      </Button>
                    </div>
                  </CardContent>
                </Card>
              )}
                
              {profile.education && profile.education.length > 0 ? (
                <div className="space-y-6">
                  {profile.education.map((edu) => (
                    // Only render the entry if it's not currently being edited
                    (activeForm !== `education-edit-${edu._id}`) && (
                      <div key={edu._id} className="border-l-4 border-purple-500 pl-4 relative bg-gray-50 p-4 rounded-lg">
                        {isOwnProfile && edu._id && (
                          <div className="absolute -top-2 -right-2 z-10">
                            <DropdownMenu>
                              <DropdownMenuTrigger asChild>
                                <Button
                                  size="sm"
                                  variant="ghost"
                                  className="p-1 h-auto"
                                >
                                  <EllipsisVerticalIcon className="w-4 h-4" />
                                </Button>
                              </DropdownMenuTrigger>
                              <DropdownMenuContent align="end">
                                <DropdownMenuItem
                                  onSelect={() => {
                                    setEducationForm({
                                      college: edu.college || '',
                                      degree: edu.degree || '',
                                      fieldOfStudy: edu.fieldOfStudy || '',
                                      startYear: edu.startYear || new Date().getFullYear(),
                                      endYear: edu.endYear || new Date().getFullYear(),
                                      current: edu.current || false
                                    });
                                    setActiveForm(`education-edit-${edu._id}`);
                                  }}
                                >
                                  Edit
                                </DropdownMenuItem>
                                <DropdownMenuItem
                                  className="text-red-600"
                                  onSelect={() => deleteEducation(edu._id!)}
                                >
                                  Delete
                                </DropdownMenuItem>
                              </DropdownMenuContent>
                            </DropdownMenu>
                          </div>
                        )}
                        <div className="pr-8">
                          <h3 className="font-semibold text-lg text-gray-900">
                            {edu.degree}
                          </h3>
                        </div>
                        <p className="text-gray-700 font-medium">
                          {edu.college}
                        </p>
                        <p className="text-gray-600">
                          {edu.fieldOfStudy}
                        </p>
                        <p className="text-gray-600 text-sm mt-1">
                          {edu.startYear} - {edu.current ? 'Present' : edu.endYear}
                        </p>
                      </div>
                    )
                  ))}
                </div>
              ) : (
                <p className="text-gray-500 italic">
                  No education information added yet.
                </p>
              )}
            </div>
          </div>

          {/* Featured Activities Section */}
          <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div className="bg-gradient-to-r from-green-500 to-teal-500 p-4">
              <h2 className="text-lg font-bold text-white flex items-center gap-2">
                <ChatBubbleLeftIcon className="w-5 h-5" />
                Featured Activities
              </h2>
            </div>
            <div className="p-6">
              <UserPostsSection userId={profile.id} isOwnProfile={isOwnProfile} currentUserId={currentUserId} />
            </div>
          </div>
              </div>
            </div>
          </div>
      </div>
    </ProtectedRoute>
  );
}

export default ProfilePage;